<%= render 'shared/project_header', project: @project %>
<div id="vue-app">
  <forum-vue>
    <div class="row">
      <div v-if="activePage === 'postsIndex'" class="col-md-8 mx-auto mt-3">
        <label class="form-label visually-hidden" for="searchText">Pesquisar</label>
        <input class="form-control mb-3" v-model="searchText" type="text" name="searchText" id="searchText" placeholder="Busque por postagens">

        <div class="list-group">
          <div class="list-group-item" v-for="post in filteredPosts" :key="post.id">
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1"><a href="#" @click.prevent="showPostDetails(post.id)"> {{ post.title }}</a></h5>
              <small>{{ post.date }}</small>
            </div>
            <p class="mb-1">{{ post.body }}</p>
            <small>por {{ post.author }}</small>
          </div>
        </div>
      </div>

      <div v-if="activePage === 'postDetails'">
        <div>
          <h3>{{ selectedPost.title }}</h3>
          <p>{{ selectedPost.body }}</p>
        </div>

        <div class="list-group">
          <p>Comentários:</p>
          <div class="list-group-item" v-if="comments.length > 0" v-for="comment in comments" :key="comment.id">
            <div class="d-flex w-100 justify-content-between">
              <p class="mb-1">{{ comment.content }}</p>

              <small>{{ comment.created_at }}</small>
            </div>
            <small>por {{ comment.author }}</small>
          </div>
          <div v-else>
            <p>Seja o primeiro a comentar</p>
          </div>
          <form @submit.prevent='createComment' class="mt-4">
            <div>
              <label for="content" class="d-none">Conteúdo:</label>
              <textarea id="content" v-model="newComment.content" placeholder='Insira um comentário' class="form-control"></textarea>
              <div v-if="errorMessages.length > 0" v-for="msg in errorMessages">
                <small class="text-danger">{{ msg }}</small>
              </div>
            </div>
            <div>
              <button type="submit" class="btn btn-primary mt-3">Comentar</button>
            </div>
          </form>
          <div>
            <button class='btn btn-outline-primary mt-3' @click="loadPosts">Voltar</button>
          </div>
        </div>
      </div>
    </div>
  </forum-vue>
</div>

<script>
  var project = "<%= @project.title %>"
  var posts = <%= @posts.map { |post| { id: post.id,
                                        title: post.title,
                                        body: post.body,
                                        comments: post.comments.map { |comment|
                                          { 
                                            id: comment.id,
                                            content: comment.content,
                                            author: comment.user_role.user.full_name,
                                            created_at: comment.updated_at == comment.created_at ? "Postado há #{time_ago_in_words(comment.created_at)}" : "(Editado) #{time_ago_in_words(comment.updated_at)}",
                                          }
                                        },
                                        created_at: post.updated_at == post.created_at ? "Postado em #{time_ago_in_words(post.created_at)}" : "(Editado) #{time_ago_in_words(post.updated_at)}",
                                        user_name: post.user.full_name } }.to_json.html_safe %>;
                                        
</script>